/*
Задание:
Назначьте скидку 15% на товары, цена которых превышает среднюю цену на все товары на 50 и более рублей, а также скидку 10% на товары, цена которых ниже средней на 50 и более рублей. 
Цену остальных товаров внутри диапазона (среднее - 50; среднее + 50) оставьте без изменений. При расчёте средней цены, округлите её до двух знаков после запятой.
Выведите информацию о всех товарах с указанием старой и новой цены. Колонку с новой ценой назовите new_price.
Результат отсортируйте сначала по убыванию прежней цены в колонке price, затем по возрастанию id товара.
Поля в результирующей таблице: product_id, name, price, new_price
*/

with subquery as(SELECT round(avg(price), 2) as avg_price
                 FROM   products)
SELECT product_id,
       name,
       price,
       case when price >= (SELECT *
                    FROM   subquery) + 50 then price * 0.85 when price <= (SELECT *
                                                       FROM   subquery) - 50 then price * 0.9 else price end as new_price
FROM   products
ORDER BY price desc, product_id
