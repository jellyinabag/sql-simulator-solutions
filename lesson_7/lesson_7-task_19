/*
Задание:
Для каждого заказа, в котором больше 5 товаров, рассчитайте время, затраченное на его доставку. 
В результат включите id заказа, время принятия заказа курьером, время доставки заказа и время, затраченное на доставку. Новые колонки назовите соответственно time_accepted, time_delivered и delivery_time.
В расчётах учитывайте только неотменённые заказы. Время, затраченное на доставку, выразите в минутах, округлив значения до целого числа. Результат отсортируйте по возрастанию id заказа.
Поля в результирующей таблице: order_id, time_accepted, time_delivered и delivery_time
*/

SELECT order_id,
       min(case when action = 'accept_order' then time end) as time_accepted,
       min(case when action = 'deliver_order' then time end) as time_delivered,
       round((extract(epoch
FROM   (min(case when action = 'deliver_order' then time end) - min(case when action = 'accept_order' then time end)))) / 60)::integer as delivery_time
FROM   courier_actions
WHERE  order_id in (SELECT order_id
                    FROM   orders
                    WHERE  array_length(product_ids, 1) > 5)
   and order_id not in (SELECT order_id
                     FROM   courier_actions
                     WHERE  action = 'cancel_order')
GROUP BY order_id having min(case when action = 'deliver_order' then time end) is not null and min(case when action = 'accept_order' then time end) is not null
ORDER BY order_id
