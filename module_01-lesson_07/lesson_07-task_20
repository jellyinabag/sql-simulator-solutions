/*
Задание:
Для каждой даты в таблице user_actions посчитайте количество первых заказов, совершённых пользователями.
Первыми заказами будем считать заказы, которые пользователи сделали в нашем сервисе впервые. В расчётах учитывайте только неотменённые заказы.
В результат включите две колонки: дату и количество первых заказов в эту дату. Колонку с датами назовите date, а колонку с первыми заказами — first_orders.
Результат отсортируйте по возрастанию даты.
Поля в результирующей таблице: date, first_orders
*/

with time_per_user as (SELECT min(time) as min_time,
                              user_id
                       FROM   user_actions
                       WHERE  action = 'create_order'
                          and order_id not in (SELECT order_id
                                            FROM   user_actions
                                            WHERE  action = 'cancel_order')
                       GROUP BY user_id), date_per_user as (SELECT to_char(min_time, 'YYYY-MM-DD') as min_date,
                                            user_id
                                     FROM   time_per_user
                                     ORDER BY min_date)
SELECT min_date as date,
       count(user_id) as first_orders
FROM   date_per_user
GROUP BY date
ORDER BY date
