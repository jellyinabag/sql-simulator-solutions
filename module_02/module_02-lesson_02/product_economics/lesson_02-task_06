/*
Задание:
Для каждого товара, представленного в таблице products, за весь период времени в таблице orders рассчитайте следующие показатели:
1. Суммарную выручку, полученную от продажи этого товара за весь период.
2. Долю выручки от продажи этого товара в общей выручке, полученной за весь период.
Колонки с показателями назовите соответственно revenue и share_in_revenue. Колонку с наименованиями товаров назовите product_name.
Долю выручки с каждого товара необходимо выразить в процентах. При её расчёте округляйте значения до двух знаков после запятой.
Товары, округлённая доля которых в выручке составляет менее 0.5%, объедините в общую группу с названием «ДРУГОЕ» (без кавычек), просуммировав округлённые доли этих товаров.
Результат должен быть отсортирован по убыванию выручки от продажи товара.
Поля в результирующей таблице: product_name, revenue, share_in_revenue
*/

with unnest_products as (SELECT order_id,
                                unnest(product_ids) as product_id
                         FROM   orders
                         WHERE  order_id not in (SELECT order_id
                                                 FROM   user_actions
                                                 WHERE  action = 'cancel_order')), count_products as (SELECT product_id,
                                                            count(order_id) as count_products
                                                     FROM   unnest_products
                                                     GROUP BY product_id), prices as (SELECT product_id,
                                        name,
                                        count_products * price as revenue_per_product
                                 FROM   count_products join products using(product_id)), revenue as (SELECT sum(revenue_per_product) as revenue
                                                                    FROM   prices), count_revenue_share as (SELECT name as product_name,
                                               revenue_per_product as revenue,
                                               round(revenue_per_product * 100 / revenue::decimal, 2) as share_in_revenue
                                        FROM   prices cross join revenue)
SELECT case when share_in_revenue < 0.5 then 'ДРУГОЕ'
            else product_name end as product_name,
       sum(revenue) as revenue,
       round(sum(share_in_revenue), 2) as share_in_revenue
FROM   count_revenue_share
GROUP BY case when share_in_revenue < 0.5 then 'ДРУГОЕ' else product_name end
ORDER BY revenue desc
