/*
Задание:
Для каждого дня, представленного в таблице user_actions, рассчитайте следующие показатели:
1. Долю пользователей, сделавших в этот день всего один заказ, в общем количестве платящих пользователей.
2. Долю пользователей, сделавших в этот день несколько заказов, в общем количестве платящих пользователей.
Колонки с показателями назовите соответственно single_order_users_share, several_orders_users_share. Колонку с датами назовите date. 
Все показатели с долями необходимо выразить в процентах. При расчёте долей округляйте значения до двух знаков после запятой.
Результат должен быть отсортирован по возрастанию даты.
Поля в результирующей таблице: date, single_order_users_share, several_orders_users_share
*/

with count_orders as (SELECT time::date as date,
                             user_id,
                             count(order_id) as count_orders
                      FROM   user_actions
                      WHERE  action = 'create_order'
                         and order_id not in (SELECT order_id
                                           FROM   user_actions
                                           WHERE  action = 'cancel_order')
                      GROUP BY date, user_id), users_per_day as (SELECT time::date as date,
                                                  count(distinct user_id) as paying_users
                                           FROM   user_actions
                                           WHERE  action = 'create_order'
                                              and order_id not in (SELECT order_id
                                                                FROM   user_actions
                                                                WHERE  action = 'cancel_order')
                                           GROUP BY date)
SELECT data.date,
       round(single_order * 100 / paying_users::decimal, 2) as single_order_users_share,
       round(several_orders * 100 / paying_users::decimal,
             2) as several_orders_users_share
FROM   (SELECT date,
               count(user_id) filter (WHERE count_orders = 1) as single_order,
               count(user_id) filter (WHERE count_orders > 1) as several_orders
        FROM   count_orders
        GROUP BY date) as data join users_per_day using(date)
