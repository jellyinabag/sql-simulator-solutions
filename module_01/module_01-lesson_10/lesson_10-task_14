/*
Задание:
Из таблицы courier_actions отберите топ 10% курьеров по количеству доставленных за всё время заказов. 
Выведите id курьеров, количество доставленных заказов и порядковый номер курьера в соответствии с числом доставленных заказов.
У курьера, доставившего наибольшее число заказов, порядковый номер должен быть равен 1, 
а у курьера с наименьшим числом заказов — числу, равному десяти процентам от общего количества курьеров в таблице courier_actions.
При расчёте номера последнего курьера округляйте значение до целого числа.
Колонки с количеством доставленных заказов и порядковым номером назовите соответственно orders_count и courier_rank. Результат отсортируйте по возрастанию порядкового номера курьера.
Поля в результирующей таблице: courier_id, orders_count, courier_rank 
*/

with orders_per_courier as (SELECT courier_id,
                                   count(order_id) filter (WHERE action = 'deliver_order') as orders_count
                            FROM   courier_actions
                            GROUP BY courier_id), couriers_number as (SELECT (count(distinct courier_id) * 0.1)::integer as couriers_10
                                          FROM   courier_actions), couriers_ranked as (SELECT courier_id,
                                                    orders_count,
                                                    row_number() OVER(ORDER BY orders_count desc, courier_id) as courier_rank
                                             FROM   orders_per_courier)
SELECT courier_id,
       orders_count,
       courier_rank
FROM   couriers_ranked
WHERE  courier_rank <= (SELECT couriers_10
                        FROM   couriers_number)
ORDER BY courier_rank
