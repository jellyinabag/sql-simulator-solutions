/*
Задание:
На основе данных в таблицах user_actions, courier_actions и orders для каждого дня рассчитайте следующие показатели:
- Число платящих пользователей на одного активного курьера.
- Число заказов на одного активного курьера.
Колонки с показателями назовите соответственно users_per_courier и orders_per_courier. Колонку с датами назовите date. При расчёте показателей округляйте значения до двух знаков после запятой.
Результирующая таблица должна быть отсортирована по возрастанию даты.
Поля в результирующей таблице: date, users_per_courier, orders_per_courier
*/

with users_and_orders as (SELECT user_id,
                                 time::date as date
                          FROM   user_actions
                          WHERE  action = 'create_order'
                             and order_id not in (SELECT order_id
                                               FROM   user_actions
                                               WHERE  action = 'cancel_order')), users_per_day as (SELECT date,
                                                           count(distinct user_id) as paying_users
                                                    FROM   users_and_orders
                                                    GROUP BY date), couriers_and_orders as (SELECT courier_id,
                                               time::date as date
                                        FROM   courier_actions
                                        WHERE  (action = 'accept_order'
                                           and order_id in (SELECT order_id
                                                         FROM   courier_actions
                                                         WHERE  action = 'deliver_order'))
                                            or action = 'deliver_order'), couriers_per_day as (SELECT date,
                                                          count(distinct courier_id) as active_couriers
                                                   FROM   couriers_and_orders
                                                   GROUP BY date), count_orders as (SELECT creation_time::date as date,
                                        count(distinct order_id) filter (WHERE order_id not in (SELECT order_id
                                                                                         FROM   user_actions
                                                                                         WHERE  action = 'cancel_order')) as orders_per_day
                                 FROM   orders
                                 GROUP BY date)
SELECT users_per_day.date,
       round(paying_users::decimal / active_couriers, 2) as users_per_courier,
       round(orders_per_day::decimal / active_couriers, 2) as orders_per_courier
FROM   users_per_day join couriers_per_day using (date) join count_orders using (date)
ORDER BY date
